{% extends "base/admin_base.html" %}

{% block title %}{{ _('Google Merchant Feed') }} - Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-google"></i> {{ _('Google Merchant Feed Settings') }}</h1>
    <div class="page-actions">
        <a href="{{ url_for('refresh_all_feeds', token=token) }}" class="btn btn-success">
            <i class="bi bi-arrow-repeat"></i> {{ _('Update All Feeds') }}
        </a>
        <a href="{{ url_for('admin_dashboard', token=token) }}" class="btn-back">
            <i class="bi bi-arrow-left"></i> {{ _('Back to Dashboard') }}
        </a>
    </div>
</div>

<!-- Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="stat-card primary">
            <div class="stat-value">{{ settings|length }}</div>
            <div class="stat-label">{{ _('Total Configurations') }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card success">
            <div class="stat-value">{{ settings|selectattr('enabled')|list|length }}</div>
            <div class="stat-label">{{ _('Active Feeds') }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card warning">
            <div class="stat-value">{{ languages|length }}</div>
            <div class="stat-label">{{ _('Languages') }}</div>
        </div>
    </div>
</div>

<!-- Feed Links -->
<div class="filter-card mb-4">
    <h6><i class="bi bi-link-45deg me-2"></i>{{ _('Feed Links') }}</h6>
    <div class="btn-group flex-wrap">
        {% for lang in languages %}
        <div class="btn-group me-2 mb-2">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-flag me-1"></i>{{ lang|upper }}
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a class="dropdown-item" href="/google-merchant-feed/{{ lang }}.xml" target="_blank">
                        <i class="bi bi-eye me-2"></i>{{ _('View Feed') }}
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="/google-merchant-feed/{{ lang }}.xml?download=1">
                        <i class="bi bi-download me-2"></i>{{ _('Download Feed') }}
                    </a>
                </li>
            </ul>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add New Configuration -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-plus-circle me-2"></i>{{ _('Add New Feed Configuration') }}
    </div>
    <div class="card-body">
        <form method="POST">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="form-check form-switch mb-3">
                        <input type="checkbox" class="form-check-input" id="enabled" name="enabled" checked>
                        <label class="form-check-label" for="enabled">{{ _('Enable Feed') }}</label>
                    </div>

                    <div class="mb-3">
                        <label for="category" class="form-label">{{ _('Google Category') }} *</label>
                        <input type="text" class="form-control" id="category" name="category" 
                               required placeholder="{{ _('e.g. Vehicle Parts & Accessories > Car Parts') }}">
                    </div>

                    <div class="mb-3">
                        <label for="brand_id" class="form-label">{{ _('Brand') }} *</label>
                        <select class="form-select" id="brand_id" name="brand_id" required>
                            <option value="-1">{{ _('All Brands') }}</option>
                            {% for brand in brands %}
                                {% if brand.id != -1 %}
                                    <option value="{{ brand.id }}">{{ brand.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="language" class="form-label">{{ _('Language') }} *</label>
                        <select class="form-select" id="language" name="language" required>
                            {% for lang in languages %}
                            <option value="{{ lang }}">{{ lang|upper }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="price_list_id" class="form-label">{{ _('Price List') }} *</label>
                        <select name="price_list_id" class="form-select" required>
                            <option value="">{{ _('Select Price List') }}</option>
                            {% for pl in price_lists %}
                            <option value="{{ pl.table_name }}">{{ pl.table_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="markup" class="form-label">{{ _('Markup Percentage') }}</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="markup" name="markup" 
                                   value="0" step="0.01" min="0">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-2"></i>{{ _('Save Configuration') }}
            </button>
        </form>
    </div>
</div>

<!-- Current Configurations -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-list-ul me-2"></i>{{ _('Current Configurations') }}
    </div>
    {% if settings %}
    <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
            <thead>
                <tr>
                    <th>{{ _('Status') }}</th>
                    <th>{{ _('Brand') }}</th>
                    <th>{{ _('Category') }}</th>
                    <th>{{ _('Language') }}</th>
                    <th>{{ _('Price List') }}</th>
                    <th>{{ _('Markup') }}</th>
                    <th>{{ _('Created') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for setting in settings %}
                <tr>
                    <td>
                        <span class="badge bg-{{ 'success' if setting.enabled else 'danger' }}">
                            {{ _('Active') if setting.enabled else _('Inactive') }}
                        </span>
                    </td>
                    <td>{{ setting.brand_name or _('All Brands') }}</td>
                    <td>
                        <span title="{{ setting.category }}">
                            {{ setting.category[:30] }}{% if setting.category|length > 30 %}...{% endif %}
                        </span>
                    </td>
                    <td><span class="badge bg-primary">{{ setting.language|upper }}</span></td>
                    <td>{{ setting.price_list_id }}</td>
                    <td>{{ setting.markup_percentage }}%</td>
                    <td>{{ setting.created_at.strftime('%d.%m.%Y') if setting.created_at else 'â€”' }}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('refresh_google_feed', token=token, setting_id=setting.id) }}" 
                               class="btn btn-outline-primary" title="{{ _('Update') }}">
                                <i class="bi bi-arrow-clockwise"></i>
                            </a>
                            <form action="{{ url_for('delete_google_feed', token=token, setting_id=setting.id) }}" 
                                  method="post" class="d-inline">
                                <button type="submit" class="btn btn-outline-danger"
                                        onclick="return confirm('{{ _('Delete this feed configuration?') }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="card-body">
        <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle me-2"></i> {{ _('No feed configurations yet. Add one above.') }}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
