{% extends "base/admin_base.html" %}

{% block title %}{{ _('Missing Descriptions') }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-file-text"></i> {{ _('Products Without Descriptions') }}</h1>
    <div class="page-actions">
        <a href="{{ url_for('admin_dashboard', token=token) }}" class="btn-back">
            <i class="bi bi-arrow-left"></i> {{ _('Back to Dashboard') }}
        </a>
    </div>
</div>

<p class="text-muted mb-4">{{ _('Found') }} {{ total_count }} {{ _('products from stock without descriptions') }}</p>

<!-- Filter -->
<div class="filter-card">
    <form method="GET" class="row g-3 align-items-end">
        <div class="col-md-3">
            <label class="form-label">{{ _('Filter by Brand') }}</label>
            <select name="brand" class="form-select">
                <option value="">{{ _('All Brands') }}</option>
                {% for brand in brands %}
                <option value="{{ brand }}" {% if brand_filter == brand %}selected{% endif %}>{{ brand }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">{{ _('Min. Price') }} (€)</label>
            <input type="number" step="0.01" name="min_price" class="form-control" 
                   value="{{ min_price or '' }}" placeholder="0.00">
        </div>
        <div class="col-md-3">
            <div class="form-check">
                <input type="checkbox" name="incomplete_only" id="incomplete_only" class="form-check-input" 
                       value="1" {% if incomplete_only %}checked{% endif %}>
                <label class="form-check-label" for="incomplete_only">
                    Неповні описи ({{ incomplete_products_count }})
                </label>
            </div>
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-funnel"></i> {{ _('Filter') }}
            </button>
            {% if brand_filter or min_price or incomplete_only %}
            <a href="{{ url_for('admin_products_missing_descriptions', token=token) }}" class="btn btn-outline-secondary">
                {{ _('Clear') }}
            </a>
            {% endif %}
        </div>
    </form>
</div>

<!-- Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card danger">
            <div class="stat-value">{{ total_count }}</div>
            <div class="stat-label">{{ _('Total without descriptions') }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card warning">
            <div class="stat-value">{{ in_stock_count }}</div>
            <div class="stat-label">{{ _('In stock') }} (qty > 0)</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card primary">
            <div class="stat-value">{{ "%.2f"|format(total_value) }} €</div>
            <div class="stat-label">{{ _('Total value') }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ brands|length }}</div>
            <div class="stat-label">{{ _('Brands') }}</div>
        </div>
    </div>
</div>

<!-- Дія: Додати новий артикул -->
<div class="card mb-4 bg-info bg-opacity-10 border-info">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h6 class="card-title mb-2"><i class="bi bi-plus-circle-fill text-info"></i> Додати новий артикул</h6>
                <p class="text-muted small mb-0">Створити опис для артикула якого немає в base, але треба додати</p>
            </div>
            <div class="col-md-6 text-end">
                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addNewArticleModal">
                    <i class="bi bi-plus"></i> Додати новий
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal для додавання нового артикула -->
<div class="modal fade" id="addNewArticleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Додати новий артикул</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addArticleForm">
                    <div class="mb-3">
                        <label for="newArticle" class="form-label">Артикул <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="newArticle" placeholder="Напр. LR123456" required>
                    </div>
                    <div class="mb-3">
                        <label for="newBrand" class="form-label">Бренд</label>
                        <select class="form-select" id="newBrand">
                            <option value="">Виберіть бренд...</option>
                            {% for brand in brands %}
                            <option value="{{ brand }}">{{ brand }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                <button type="button" class="btn btn-primary" onclick="addNewArticle()">Створити</button>
            </div>
        </div>
    </div>
</div>

<script>
function addNewArticle() {
    const article = document.getElementById('newArticle').value.trim().toUpperCase();
    if (!article) {
        alert('Введіть артикул!');
        return;
    }
    // Редирект на форму редагування з новим артикулом
    window.location.href = "{{ url_for('admin_edit_product', token=token, article='PLACEHOLDER') }}".replace('PLACEHOLDER', article);
}
</script>
    </div>
</div>

<!-- Products Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>{{ _('Products') }} ({{ _('page') }} {{ current_page }} {{ _('of') }} {{ total_pages }})</span>
        <button class="btn btn-sm btn-outline-primary" onclick="copyArticles()">
            <i class="bi bi-clipboard"></i> {{ _('Copy Articles') }}
        </button>
    </div>
    
    {% if products %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>#</th>
                    <th>{{ _('Article') }}</th>
                    <th>{{ _('Brand') }}</th>
                    <th>{{ _('Qty') }}</th>
                    <th>{{ _('Price') }}</th>
                    <th>{{ _('Value') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr>
                    <td>{{ (current_page - 1) * 50 + loop.index }}</td>
                    <td>
                        <a href="{{ url_for('product_details', article=product.article) }}" target="_blank" class="article-link">
                            {{ product.article }}
                        </a>
                    </td>
                    <td><span class="badge bg-secondary">{{ product.brand_name or 'N/A' }}</span></td>
                    <td><span class="badge bg-{{ 'success' if product.quantity > 0 else 'danger' }}">{{ product.quantity }}</span></td>
                    <td>{{ "%.2f"|format(product.price) }} €</td>
                    <td><strong>{{ "%.2f"|format(product.price * product.quantity) }} €</strong></td>
                    <td>
                        <a href="{{ url_for('admin_product_card', token=token, article=product.article) }}" 
                           class="btn btn-primary btn-sm" title="{{ _('Edit Product Card') }}">
                            <i class="bi bi-pencil-square"></i>
                        </a>
                        <a href="https://google.com/search?q={{ product.article }}" 
                           target="_blank" class="btn btn-outline-secondary btn-sm" title="Google">
                            <i class="bi bi-google"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="card-body">
        <nav>
            <ul class="pagination justify-content-center mb-0">
                {% if current_page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin_products_missing_descriptions', token=token, page=current_page-1, brand=brand_filter, min_price=min_price) }}">«</a>
                </li>
                {% endif %}

                {% for page_num in range(1, total_pages + 1) %}
                    {% if page_num <= 3 or page_num >= total_pages - 2 or (page_num >= current_page - 1 and page_num <= current_page + 1) %}
                    <li class="page-item {% if page_num == current_page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('admin_products_missing_descriptions', token=token, page=page_num, brand=brand_filter, min_price=min_price) }}">{{ page_num }}</a>
                    </li>
                    {% elif page_num == 4 and current_page > 5 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% elif page_num == total_pages - 3 and current_page < total_pages - 4 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}

                {% if current_page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin_products_missing_descriptions', token=token, page=current_page+1, brand=brand_filter, min_price=min_price) }}">»</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}

    {% else %}
    <div class="card-body text-center py-5">
        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
        <h4 class="mt-3">{{ _('Excellent!') }}</h4>
        <p class="text-muted">{{ _('All products in stock have descriptions') }}</p>
    </div>
    {% endif %}
</div>

<!-- Hidden textarea for copying -->
<textarea id="articlesText" style="position: absolute; left: -9999px;">{% for p in products %}{{ p.article }}
{% endfor %}</textarea>
{% endblock %}

{% block extra_js %}
<script>
function copyArticles() {
    const text = document.getElementById('articlesText');
    text.select();
    document.execCommand('copy');
    alert('{{ _("Articles copied to clipboard!") }}');
}
</script>
{% endblock %}
