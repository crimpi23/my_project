{% extends "base/public_base.html" %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/public-index.css') }}">
{% endblock %}

{% block meta_description %}{{ _('AutogroupEU - Your reliable partner in auto parts supply across Europe.') }}{% endblock %}
{% block og_title %}AutogroupEU - {{ _('Auto Parts Supply') }}{% endblock %}
{% block og_description %}{{ _('Find the best auto parts for your vehicle with quick delivery across Europe') }}{% endblock %}

{% block title %}{{ _('Home') }} - AutogroupEU{% endblock %}

{% block content %}
<div class="main-content-wide mt-4 home-page">
    <div class="pre-products-bar-scroll">
      <div class="pre-products-bar-inner">
        <!-- Need Help -->
        <button class="mini-card btn-card" id="openHelpModal" type="button">
          <div class="mini-title"><i class="bi bi-headset me-2"></i>{{ _('Need Help?') }}</div>
          <div class="mini-sub">{{ _("If you have any questions, don't hesitate to contact us:") }}</div>
        </button>
        <!-- Car Service -->
        <button class="mini-card btn-card" id="openServiceModal" type="button">
          <div class="mini-title"><i class="bi bi-tools me-2"></i>{{ _('Car Service & Programming') }}</div>
          <div class="mini-sub">{{ _('We offer professional car repair and programming services.') }}</div>
        </button>
        <!-- VIN Request -->
        <button class="mini-card btn-card" id="openVinModal" type="button">
          <div class="mini-title"><i class="bi bi-key me-2"></i>{{ _('VIN Request') }}</div>
          <div class="mini-sub">{{ _('Request parts by VIN code') }}</div>
        </button>
      </div>
    </div>

    {% if selected_category %}
    <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
        <a href="{{ url_for('index') }}" class="breadcrumb-link">{{ _('All Products') }}</a>
        
        {% if parent_category_obj %}
        <span class="breadcrumb-sep">/</span>
        <a href="{{ url_for('index', category=parent_category_obj.id) }}" class="breadcrumb-link">
            {{ parent_category_obj.name }}
        </a>
        {% endif %}
        
        {% if selected_category_obj %}
        <span class="breadcrumb-sep">/</span>
        <span class="breadcrumb-current">{{ selected_category_obj.name }}</span>
        {% endif %}
    </nav>
    {% endif %}

    <div class="catalog-layout">
        {% if categories %}
        <aside class="catalog-sidebar" id="catalogSidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">
                    <i class="bi bi-list-nested me-2"></i>{{ _('Product Categories') }}
                </h3>
            </div>
            <nav class="sidebar-nav">
                <ul class="sidebar-menu">
                    <li class="sidebar-item">
                        <a href="{{ url_for('index') }}" class="sidebar-link {% if not selected_category %}active{% endif %}">
                            <i class="bi bi-grid-3x3-gap-fill"></i>
                            <span>{{ _('All Products') }}</span>
                        </a>
                    </li>
                    {% for category in categories %}
                    <li class="sidebar-item {% if category.id == selected_category or category.id in parent_category_ids %}expanded{% endif %}">
                        <div class="sidebar-link-row">
                            {% if category.children %}
                            <button type="button" class="sidebar-toggle" data-target="sidebarSub{{ category.id }}">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                            {% endif %}
                            <a href="{{ url_for('index', category=category.id) }}" 
                               class="sidebar-link {% if selected_category == category.id %}active{% endif %}">
                                {% if category.icon_class %}<i class="bi {{ category.icon_class }}"></i>{% else %}<i class="bi bi-folder"></i>{% endif %}
                                <span>{{ category.name }}</span>
                            </a>
                        </div>
                        {% if category.children %}
                        <ul class="sidebar-submenu {% if category.id == selected_category or category.id in parent_category_ids %}open{% endif %}" id="sidebarSub{{ category.id }}">
                            {% for sub in category.children %}
                            <li class="sidebar-item {% if sub.id == selected_category or sub.id in parent_category_ids %}expanded{% endif %}">
                                <div class="sidebar-link-row">
                                    {% if sub.children %}
                                    <button type="button" class="sidebar-toggle sidebar-toggle-l2" data-target="sidebarSub{{ sub.id }}">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                    {% endif %}
                                    <a href="{{ url_for('index', category=sub.id) }}" 
                                       class="sidebar-link {% if selected_category == sub.id %}active{% endif %}">
                                        <span>{{ sub.name }}</span>
                                    </a>
                                </div>
                                {% if sub.children %}
                                <ul class="sidebar-submenu sidebar-submenu-l3 {% if sub.id == selected_category or sub.id in parent_category_ids %}open{% endif %}" id="sidebarSub{{ sub.id }}">
                                    {% for sub3 in sub.children %}
                                    <li class="sidebar-item">
                                        <a href="{{ url_for('index', category=sub3.id) }}" 
                                           class="sidebar-link sidebar-link-l3 {% if selected_category == sub3.id %}active{% endif %}">
                                            <span>{{ sub3.name }}</span>
                                        </a>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </nav>
        </aside>
        {% endif %}

        <div class="catalog-main-content">
            <div class="mobile-catalog-toggle d-lg-none mb-3">
                <button class="catalog-btn w-100" type="button" id="openMobileCat">
                    <i class="bi bi-list-nested me-2"></i>
                    <span>{{ _('Categories') }}</span>
                    <i class="bi bi-chevron-down ms-auto"></i>
                </button>
            </div>
        
            <div class="stock-header-card mb-4">
                <div class="stock-header-content">
                    <div class="stock-header-icon">
                        <i class="bi bi-box-seam-fill"></i>
                    </div>
                    <div class="stock-header-text">
                        {% if selected_category_obj %}
                        <h2 class="stock-header-title">{{ selected_category_obj.name }}</h2>
                        {% else %}
                        <h2 class="stock-header-title">{{ _('Items in Our Stock') }}</h2>
                        {% endif %}
                        <p class="stock-header-subtitle">
                            <i class="bi bi-lightning-charge-fill text-warning me-1"></i>
                            {{ _('Available for immediate delivery') }}
                        </p>
                    </div>
                </div>
            </div>

        <div class="products-grid" id="productsGrid">
            {% for product in products %}
            <div class="product-card {% if product.quantity <= 0 %}out-of-stock{% endif %}">
                <a href="{{ url_for('product_details', article=product.article) }}" class="product-image-link">
                    <div class="product-image-container">
                        {% if product.quantity <= 0 %}
                        <div class="out-of-stock-badge">
                            <i class="bi bi-clock-history"></i>
                            {{ _('Out of Stock') }}
                        </div>
                        {% endif %}
                        {% if product.image_url %}
                        <img src="{{ product.image_url }}" 
                             class="product-image" 
                             alt="{{ product.name or product.article }}"
                             loading="lazy" 
                             decoding="async">
                        {% else %}
                        <div class="product-image-placeholder">
                            <i class="bi bi-image"></i>
                        </div>
                        {% endif %}
                    </div>
                </a>

                <div class="product-content">
                    <a href="{{ url_for('product_details', article=product.article) }}" class="product-title-link">
                        <h3 class="product-title">
                            {% if product.name %}{{ product.name }}{% else %}{{ product.article }}{% endif %}
                        </h3>
                    </a>
                    
                    <div class="product-meta-compact">
                        <span class="product-brand">{{ product.brand_name }}</span>
                        <span class="product-article">{{ product.article }}</span>
                    </div>
                    
                    <div class="product-prices">
                        <div class="price-main-line">
                            <span class="price-with-vat">{{ "%.2f"|format(product.price|float) }} €</span>
                            <span class="price-vat-label">{{ _('incl. VAT') }}</span>
                        </div>
                        <div class="price-secondary-line">
                            <span class="price-without-vat">{{ "%.2f"|format((product.price|float) / 1.23) }} €</span>
                            <span class="price-novat-label">{{ _('excl. VAT') }}</span>
                        </div>
                    </div>
                    
                    <div class="product-actions">
                        {% if product.quantity > 0 %}
                        <button type="button" 
                                class="btn btn-success btn-sm product-btn add-to-cart-btn"
                                data-article="{{ product.article }}"
                                data-table="stock"
                                data-price="{{ product.price }}"
                                data-brand-id="{{ product.brand_id or '' }}">
                            <i class="bi bi-cart-plus me-1"></i>
                            {{ _('Add to Cart') }}
                        </button>
                        {% else %}
                        <a href="{{ url_for('product_details', article=product.article) }}" 
                           class="btn btn-outline-primary btn-sm product-btn">
                            <i class="bi bi-eye me-1"></i>
                            {{ _('View Details') }}
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if has_more %}
        <div class="text-center mt-4">
            <button id="loadMoreButton" 
                    class="btn btn-outline-primary btn-lg load-more-btn" 
                    data-next-page="{{ (page or 1)|int + 1 }}">
                <span class="button-text">
                    <i class="bi bi-plus-circle me-2"></i>
                    {{ _('Show More Products') }}
                </span>
                <span class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
            </button>
        </div>
        {% endif %}
        </div>
    </div>
</div>

    <div id="helpModalOverlay" class="vin-modal-overlay d-none">
        <div class="vin-modal-window">
            <button class="vin-modal-close" id="closeHelpModal" aria-label="Close">&times;</button>
            <h2 class="vin-modal-title"><i class="bi bi-headset me-2"></i>{{ _('Need Help?') }}</h2>
            <p>{{ _("If you have any questions, don't hesitate to contact us:") }}</p>
            <p>
                <a href="tel:+421907400865" class="text-primary" style="font-size:1.2rem;">
                    +421 907 400 865
                </a><br>
                <span class="text-muted">{{ _('Mon-Fri: 9:00 - 19:00') }}</span>
            </p>
        </div>
    </div>

    <div id="serviceModalOverlay" class="vin-modal-overlay d-none">
        <div class="vin-modal-window">
            <button class="vin-modal-close" id="closeServiceModal" aria-label="Close">&times;</button>
            <h2 class="vin-modal-title"><i class="bi bi-tools me-2"></i>{{ _('Car Service & Programming') }}</h2>
            <p>{{ _('We offer professional car repair and programming services.') }}</p>
            <a href="{{ url_for('car_service') }}" class="btn btn-primary mt-2">{{ _('Learn More') }}</a>
        </div>
    </div>

    <div id="vinModalOverlay" class="vin-modal-overlay d-none">
    <div class="vin-modal-window">
        <button class="vin-modal-close" id="closeVinModal" aria-label="Close">&times;</button>
        <h2 class="vin-modal-title"><i class="bi bi-key me-2"></i>{{ _('VIN Request') }}</h2>
        <form id="vinModalForm" autocomplete="off">
            <div class="mb-3">
                <label for="vin_code" class="form-label">{{ _('VIN code (17 characters)') }}</label>
                <input type="text" name="vin_code" id="vin_code" maxlength="17" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">{{ _('Phone') }} (+421...)</label>
                <input type="text" name="phone" id="phone" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">{{ _('Email') }}</label>
                <input type="email" name="email" id="email" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="parts_description" class="form-label">{{ _('Describe needed parts') }}</label>
                <textarea name="parts_description" id="parts_description" class="form-control" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary w-100">{{ _('Send Request') }}</button>
            <div id="vinModalStatus" class="mt-2 small"></div>
        </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
window.translations = {
    'Brand': '{{ _("Brand") }}',
    'Article': '{{ _("Article") }}',
    'Price': '{{ _("Price") }}',
    'No description available.': '{{ _("No description available.") }}',
    'View Details': '{{ _("View Details") }}',
    'incl. VAT': '{{ _("incl. VAT") }}'
};

document.addEventListener('DOMContentLoaded', function() {
    const productLinks = document.querySelectorAll('.product-card a');
    productLinks.forEach(link => {
        link.addEventListener('auxclick', function(e) {
            if (e.button === 1 || e.which === 2) {
                e.preventDefault();
                window.open(this.href, '_blank');
            }
        });
    });

    const loadMoreButton = document.getElementById('loadMoreButton');
    if (loadMoreButton) {
        loadMoreButton.addEventListener('click', function() {
            const productsGrid = document.getElementById('productsGrid');
            const currentCount = productsGrid ? productsGrid.querySelectorAll('.product-card').length : 0;

            const perPageApi = 8;

            const nextPage = Math.floor(currentCount / perPageApi) + 1;

            const brandFilter = document.getElementById('brandFilter');
            const brandId = brandFilter ? brandFilter.value : '';
            
            const urlParams = new URLSearchParams(window.location.search);
            const categoryId = urlParams.get('category') || '';

            const spinner = this.querySelector('.spinner-border');
            const buttonText = this.querySelector('.button-text');
            spinner.classList.remove('d-none');
            buttonText.style.opacity = '0.7';
            this.disabled = true;

            fetch(`/api/products?page=${nextPage}&brand=${brandId}&category=${categoryId}&lang={{ g.locale }}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const productsGrid = document.querySelector('.products-grid');

                    data.products.forEach(product => {
                        const productHtml = createProductCard(product);
                        const productCard = document.createElement('div');
                        productCard.className = 'product-card';
                        productCard.innerHTML = productHtml;
                        productCard.style.opacity = '0';
                        productsGrid.appendChild(productCard);
                        setTimeout(() => {
                            productCard.style.transition = 'opacity 0.4s';
                            productCard.style.opacity = '1';
                        }, 10);

                        const newProductLink = productCard.querySelector('a');
                        if (newProductLink) {
                            newProductLink.addEventListener('auxclick', function(e) {
                                if (e.button === 1 || e.which === 2) {
                                    e.preventDefault();
                                    window.open(this.href, '_blank');
                                }
                            });
                        }
                    });

                    if (data.has_more) {
                        loadMoreButton.setAttribute('data-next-page', nextPage + 1);
                        loadMoreButton.disabled = false;
                        spinner.classList.add('d-none');
                        buttonText.style.opacity = '1';
                    } else {
                        loadMoreButton.parentElement.remove();
                    }
                })
                .catch(error => {
                    console.error('Error fetching products:', error);
                    loadMoreButton.disabled = false;
                    spinner.classList.add('d-none');
                    buttonText.style.opacity = '1';
                });
        });
    }
    
    function createProductCard(product) {
        const translations = window.translations || {};
        const t = function(text) {
            return translations[text] || text;
        };
        const priceWithVat = parseFloat(product.price).toFixed(2);
        const priceWithoutVat = (parseFloat(product.price) / 1.23).toFixed(2);
        
        return `
            <div class="product-image-container">
                ${product.image_url 
                    ? `<img src="${product.image_url}" class="product-image" alt="${product.name || product.article}" loading="lazy" decoding="async">`
                    : `<div class="product-image-placeholder"><i class="bi bi-image"></i></div>`
                }
            </div>
            <div class="product-content">
                <h3 class="product-title">${product.name || product.article}</h3>
                <div class="product-meta-compact">
                    <span class="product-brand">${product.brand_name}</span>
                    <span class="product-article">${product.article}</span>
                </div>
                <div class="product-prices">
                    <div class="price-main-line">
                        <span class="price-with-vat">${priceWithVat} €</span>
                        <span class="price-vat-label">${t('incl. VAT')}</span>
                    </div>
                    <div class="price-secondary-line">
                        <span class="price-without-vat">${priceWithoutVat} €</span>
                        <span class="price-novat-label">${t('excl. VAT')}</span>
                    </div>
                </div>
                <div class="product-actions">
                    <a href="/product/${product.article}" class="btn btn-primary btn-sm product-btn">
                        <i class="bi bi-eye me-1"></i>
                        ${t('View Details')}
                    </a>
                </div>
            </div>
        `;
    }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Accordion toggle
    const toggleBtn = document.getElementById('vinRequestToggle');
    const collapseDiv = document.getElementById('vinRequestCollapse');
    if (toggleBtn && collapseDiv) {
        toggleBtn.addEventListener('click', function() {
            if (collapseDiv.style.display === 'none' || !collapseDiv.style.display) {
                collapseDiv.style.display = 'block';
                toggleBtn.classList.add('active');
            } else {
                collapseDiv.style.display = 'none';
                toggleBtn.classList.remove('active');
            }
        });
    }

    // VIN form AJAX
    const vinForm = document.getElementById('vinRequestForm');
    if (vinForm) {
        vinForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const statusDiv = document.getElementById('vinRequestStatus');
            statusDiv.textContent = '';
            statusDiv.className = 'mt-2 small';
            fetch('/vin-request', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    vin_code: form.vin_code.value,
                    phone: form.phone.value,
                    email: form.email.value,
                    parts_description: form.parts_description.value
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    statusDiv.textContent = '{{ _("Request sent successfully!") }}';
                    statusDiv.className = 'mt-2 small text-success';
                    form.reset();
                } else {
                    statusDiv.textContent = data.error || '{{ _("Error sending request") }}';
                    statusDiv.className = 'mt-2 small text-danger';
                }
            })
            .catch((err) => {
                statusDiv.textContent = '{{ _("Server error") }}';
                statusDiv.className = 'mt-2 small text-danger';
                console.error('VIN request error:', err);
            });
        });
    }

    /* Welcome strip once per session */
    const welcomeStrip = document.getElementById('welcomeStrip');
    const closeWelcome = document.getElementById('closeWelcomeStrip');
    if (welcomeStrip) {
        if (!sessionStorage.getItem('welcomeStripClosed')) {
            welcomeStrip.classList.remove('d-none');
        }
        closeWelcome.addEventListener('click', () => {
            welcomeStrip.classList.add('d-none');
            sessionStorage.setItem('welcomeStripClosed','1');
        });
    }

    /* VIN mini toggle */
    const vinToggle = document.getElementById('vinMiniToggle');
    const vinPanel = document.getElementById('vinMiniPanel');
    const vinStatus = document.getElementById('vinMiniStatus');
    if (vinToggle && vinPanel) {
        vinToggle.addEventListener('click', () => {
            const open = vinPanel.classList.toggle('open');
            vinToggle.querySelector('.vin-toggle-text').textContent = open ? '{{ _("Close") }}' : '{{ _("Open") }}';
        });
    }

    /* VIN mini form submit */
    const vinMiniForm = document.getElementById('vinMiniForm');
    if (vinMiniForm) {
        vinMiniForm.addEventListener('submit', (e) => {
            e.preventDefault();
            vinStatus.textContent = '';
            vinStatus.className = 'small';
            const f = e.target;
            fetch('/vin-request', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    vin_code: f.vin_code.value,
                    phone: f.phone.value,
                    email: f.email.value,
                    parts_description: f.parts_description.value
                })
            }).then(r=>r.json()).then(data=>{
                if (data.success) {
                    vinStatus.textContent = '{{ _("Request sent successfully!") }}';
                    vinStatus.classList.add('text-success');
                    f.reset();
                } else {
                    vinStatus.textContent = data.error || '{{ _("Error sending request") }}';
                    vinStatus.classList.add('text-danger');
                }
            }).catch(()=>{
                vinStatus.textContent = '{{ _("Server error") }}';
                vinStatus.classList.add('text-danger');
            });
        });
    }

    // VIN Modal form AJAX
    const vinModalForm = document.getElementById('vinModalForm');
    if (vinModalForm) {
        vinModalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const statusDiv = document.getElementById('vinModalStatus');
            statusDiv.textContent = '';
            statusDiv.className = 'mt-2 small';
            fetch('/vin-request', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    vin_code: form.vin_code.value,
                    phone: form.phone.value,
                    email: form.email.value,
                    parts_description: form.parts_description.value
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    statusDiv.textContent = '{{ _("Request sent successfully!") }}';
                    statusDiv.className = 'mt-2 small text-success';
                    form.reset();
                    document.getElementById('vinModalOverlay').classList.add('d-none');
                } else {
                    statusDiv.textContent = data.error || '{{ _("Error sending request") }}';
                    statusDiv.className = 'mt-2 small text-danger';
                }
            })
            .catch((err) => {
                statusDiv.textContent = '{{ _("Server error") }}';
                statusDiv.className = 'mt-2 small text-danger';
                console.error('VIN request error:', err);
            });
        });
    }

    const closeVinModal = document.getElementById('closeVinModal');
    if (closeVinModal) {
        closeVinModal.addEventListener('click', () => {
            document.getElementById('vinModalOverlay').classList.add('d-none');
        });
    }

    const openVinModalButtons = document.querySelectorAll('[data-open-vin-modal]');
    openVinModalButtons.forEach(button => {
        button.addEventListener('click', () => {
            document.getElementById('vinModalOverlay').classList.remove('d-none');
        });
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const openVinModal = document.getElementById('openVinModal');
    if (openVinModal) {
        openVinModal.addEventListener('click', function() {
            document.getElementById('vinModalOverlay').classList.remove('d-none');
            document.body.style.overflow = 'hidden';
        });
    }
    const closeVinModal = document.getElementById('closeVinModal');
    if (closeVinModal) {
        closeVinModal.addEventListener('click', function() {
            document.getElementById('vinModalOverlay').classList.add('d-none');
            document.body.style.overflow = '';
        });
    }
    const vinModalOverlay = document.getElementById('vinModalOverlay');
    if (vinModalOverlay) {
        vinModalOverlay.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('d-none');
                document.body.style.overflow = '';
            }
        });
    }
    const vinModalForm = document.getElementById('vinModalForm');
    if (vinModalForm) {
        vinModalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const status = document.getElementById('vinModalStatus');
            status.textContent = '';
            fetch('/vin-request', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    vin_code: this.vin_code.value,
                    phone: this.phone.value,
                    email: this.email.value,
                    parts_description: this.parts_description.value
                })
            }).then(r=>r.json()).then(data=>{
                if (data.success) {
                    status.textContent = 'Request sent!';
                    status.className = 'text-success small';
                    this.reset();
                    setTimeout(() => {
                        document.getElementById('vinModalOverlay').classList.add('d-none');
                        document.body.style.overflow = '';
                        status.textContent = '';
                    }, 1200);
                } else {
                    status.textContent = data.error || 'Error';
                    status.className = 'text-danger small';
                }
            }).catch(()=>{
                status.textContent = 'Server error';
                status.className = 'text-danger small';
            });
        });
    }

    // Need Help Modal
    const openHelpModal = document.getElementById('openHelpModal');
    const helpModalOverlay = document.getElementById('helpModalOverlay');
    const closeHelpModal = document.getElementById('closeHelpModal');
    
    if (openHelpModal && helpModalOverlay) {
        openHelpModal.onclick = function() {
            helpModalOverlay.classList.remove('d-none');
            document.body.style.overflow = 'hidden';
        };
        if (closeHelpModal) {
            closeHelpModal.onclick = function() {
                helpModalOverlay.classList.add('d-none');
                document.body.style.overflow = '';
            };
        }
        helpModalOverlay.onclick = function(e) {
            if (e.target === this) {
                this.classList.add('d-none');
                document.body.style.overflow = '';
            }
        };
    }

    // Car Service Modal
    const openServiceModal = document.getElementById('openServiceModal');
    const serviceModalOverlay = document.getElementById('serviceModalOverlay');
    const closeServiceModal = document.getElementById('closeServiceModal');
    
    if (openServiceModal && serviceModalOverlay) {
        openServiceModal.onclick = function() {
            serviceModalOverlay.classList.remove('d-none');
            document.body.style.overflow = 'hidden';
        };
        if (closeServiceModal) {
            closeServiceModal.onclick = function() {
                serviceModalOverlay.classList.add('d-none');
                document.body.style.overflow = '';
            };
        }
        serviceModalOverlay.onclick = function(e) {
            if (e.target === this) {
                this.classList.add('d-none');
                document.body.style.overflow = '';
            }
        };
    }


    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const article = this.dataset.article;
            const table = this.dataset.table || 'stock';
            const price = this.dataset.price;
            const button = this;
            
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>{{ _("Adding...") }}';
            button.disabled = true;
            
            const brandId = this.dataset.brandId || '';
            const selectedPrice = `${table}:${price}|${brandId}`;
            
            fetch('/public_add_to_cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json'
                },
                body: `article=${encodeURIComponent(article)}&selected_price=${encodeURIComponent(selectedPrice)}&quantity=1`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.innerHTML = '<i class="bi bi-check me-1"></i>{{ _("Added!") }}';
                    button.classList.add('added');
                    const cartBadge = document.getElementById('cart-badge');
                    if (cartBadge) {
                        cartBadge.textContent = data.cart_count;
                        cartBadge.style.display = data.cart_count > 0 ? '' : 'none';
                    }
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('added');
                        button.disabled = false;
                    }, 2000);
                } else {
                    button.innerHTML = '<i class="bi bi-x me-1"></i>{{ _("Error") }}';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                }
            })
            .catch(err => {
                console.error('Add to cart error:', err);
                button.innerHTML = originalText;
                button.disabled = false;
            });
        });
    });

    const SIDEBAR_STATE_KEY = 'sidebarCatalogState';
    const catalogSidebar = document.getElementById('catalogSidebar');
    const openMobileCatBtn = document.getElementById('openMobileCat');
    
    if (openMobileCatBtn && catalogSidebar) {
        openMobileCatBtn.addEventListener('click', () => {
            catalogSidebar.classList.toggle('open');
            document.body.style.overflow = catalogSidebar.classList.contains('open') ? 'hidden' : '';
        });
        
        catalogSidebar.addEventListener('click', (e) => {
            if (e.target === catalogSidebar) {
                catalogSidebar.classList.remove('open');
                document.body.style.overflow = '';
            }
        });
    }
    
    document.querySelectorAll('.sidebar-toggle').forEach(toggle => {
        toggle.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const targetId = toggle.getAttribute('data-target');
            const subMenu = document.getElementById(targetId);
            
            if (subMenu) {
                const isOpen = subMenu.classList.contains('open');
                
                if (isOpen) {
                    subMenu.classList.remove('open');
                    toggle.classList.remove('open');
                    subMenu.querySelectorAll('.sidebar-submenu.open').forEach(nested => {
                        nested.classList.remove('open');
                        const nestedToggle = document.querySelector(`[data-target="${nested.id}"]`);
                        if (nestedToggle) nestedToggle.classList.remove('open');
                    });
                } else {
                    subMenu.classList.add('open');
                    toggle.classList.add('open');
                }
                
                saveSidebarState();
            }
        });
    });
    
    function saveSidebarState() {
        try {
            const openItems = [];
            document.querySelectorAll('.sidebar-submenu.open').forEach(sub => {
                if (sub.id) openItems.push(sub.id);
            });
            localStorage.setItem(SIDEBAR_STATE_KEY, JSON.stringify(openItems));
        } catch (e) {
            console.error('Error saving sidebar state:', e);
        }
    }
    
    function restoreSidebarState() {
        try {
            const savedState = localStorage.getItem(SIDEBAR_STATE_KEY);
            if (savedState) {
                const openItems = JSON.parse(savedState);
                openItems.forEach(id => {
                    const subMenu = document.getElementById(id);
                    const toggle = document.querySelector(`[data-target="${id}"]`);
                    if (subMenu) {
                        subMenu.classList.add('open');
                    }
                    if (toggle) {
                        toggle.classList.add('open');
                    }
                });
            }
        } catch (e) {
            console.error('Error restoring sidebar state:', e);
        }
    }
    
    restoreSidebarState();
});
</script>
{% endblock %}