{% extends "base/admin_base.html" %}

{% block title %}{{ _('Product Categories') }} - Admin{% endblock %}

{% block extra_css %}
<style>
/* Select dropdown styling */
.category-select {
    color: #000 !important;
    font-size: 14px;
    background-color: #ffffff !important;
}

.category-select option {
    padding: 8px;
    background-color: white !important;
    color: #000 !important;
}

.category-select option:hover {
    background-color: #e7f3ff !important;
}

.category-select option:checked {
    background-color: #b3d9ff !important;
    color: #000 !important;
}

/* Table category badges - ensure visibility */
td .badge {
    background-color: #f0f0f0 !important;
    color: #000 !important;
    border: 1px solid #ddd;
    padding: 0.35rem 0.65rem;
}

td .badge.bg-primary {
    background-color: #0d6efd !important;
    color: #fff !important;
    border: none;
}

td .badge.bg-warning {
    background-color: #ffc107 !important;
    color: #000 !important;
}

td .badge.bg-outline-secondary {
    background-color: #fff !important;
    color: #6c757d !important;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-diagram-3"></i> {{ _('Product Categories') }}</h1>
    <div class="page-actions">
        <a href="{{ url_for('admin_dashboard', token=token) }}" class="btn-back">
            <i class="bi bi-arrow-left"></i> {{ _('Back to Dashboard') }}
        </a>
    </div>
</div>

<!-- Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card primary">
            <div class="stat-value">{{ total_items }}</div>
            <div class="stat-label">{{ _('Total Products') }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card success">
            <div class="stat-value">{{ assigned_count }}</div>
            <div class="stat-label">{{ _('With Categories') }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card warning">
            <div class="stat-value">{{ multiple_count }}</div>
            <div class="stat-label">{{ _('Multiple Categories') }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ categories|length }}</div>
            <div class="stat-label">{{ _('Available Categories') }}</div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="filter-card">
    <form method="GET" class="row g-3">
        <div class="col-md-2">
            <label class="form-label">{{ _('Article') }}</label>
            <input type="text" name="article" class="form-control" 
                   value="{{ article_filter }}" placeholder="{{ _('Search...') }}">
        </div>
        
        <div class="col-md-2">
            <label class="form-label">{{ _('Brand') }}</label>
            <select name="brand" class="form-select">
                <option value="">{{ _('All Brands') }}</option>
                {% for brand in brands %}
                <option value="{{ brand.id }}" {% if brand_filter == brand.id %}selected{% endif %}>
                    {{ brand.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-3">
            <label class="form-label">{{ _('Category') }}</label>
            <select name="category" class="form-select category-select">
                <option value="">üìÇ {{ _('All Categories') }}</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}" {% if category_filter == cat.id %}selected{% endif %} 
                    class="{% if category_filter == cat.id %}selected-category{% endif %}" 
                    style="padding-left: {% if cat.level > 0 %}{{ cat.level * 20 }}px{% endif %}; {% if cat.level == 0 %}font-weight: bold;{% endif %}">
                    {% for i in range(cat.level) %}‚Üí {% endfor %}{{ cat.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-2">
            <label class="form-label">{{ _('Status') }}</label>
            <select name="status" class="form-select">
                <option value="all" {% if status_filter == 'all' %}selected{% endif %}>üìä {{ _('All') }}</option>
                <option value="assigned" {% if status_filter == 'assigned' %}selected{% endif %}>‚úì {{ _('With Categories') }}</option>
                <option value="unassigned" {% if status_filter == 'unassigned' %}selected{% endif %}>‚úó {{ _('Without') }}</option>
                <option value="multiple" {% if status_filter == 'multiple' %}selected{% endif %}>üìö {{ _('Multiple') }} ({{ multiple_count }})</option>
            </select>
        </div>
        
        <div class="col-md-1">
            <label class="form-label">{{ _('In Stock') }}</label>
            <select name="in_stock" class="form-select">
                <option value="all" {% if in_stock_filter == 'all' %}selected{% endif %}>{{ _('All') }}</option>
                <option value="yes" {% if in_stock_filter == 'yes' %}selected{% endif %}>‚úì</option>
                <option value="no" {% if in_stock_filter == 'no' %}selected{% endif %}>‚úó</option>
            </select>
        </div>

        <div class="col-md-2 d-flex align-items-end gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i> {{ _('Filter') }}
            </button>
            {% if article_filter or category_filter or brand_filter or status_filter != 'all' or in_stock_filter != 'all' %}
            <a href="{{ url_for('admin_product_categories', token=token) }}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i>
            </a>
            {% endif %}
        </div>
    </form>
    <div class="mt-2 text-muted small">
        {{ _('Showing') }} {{ start_item }}-{{ end_item }} {{ _('of') }} {{ total_items }}
    </div>
</div>

<!-- Bulk Operations -->
<form method="POST" id="bulkForm">
    <div class="card mb-4">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="form-check d-inline-block">
                        <input type="checkbox" id="selectAllCheckbox" class="form-check-input" onchange="toggleSelectAll()">
                        <label class="form-check-label" for="selectAllCheckbox">{{ _('Select All') }}</label>
                    </div>
                    <span id="selectedCount" class="badge bg-secondary ms-2">0 {{ _('selected') }}</span>
                </div>
                
                <div class="col-md-8">
                    <div class="d-flex gap-2 justify-content-end flex-wrap">
                        <!-- Add to category -->
                        <div class="input-group input-group-sm" style="max-width: 400px;">
                            <select name="target_category" class="form-select form-select-sm">
                                <option value="">{{ _('Select category...') }}</option>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}" 
                                        style="{% if cat.level == 0 %}font-weight: bold;{% endif %}">
                                    {{ cat.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="input-group-text bg-white">
                                <input type="checkbox" name="set_as_primary" id="set_as_primary" class="form-check-input mt-0">
                                <label for="set_as_primary" class="ms-1 small mb-0">‚òÖ {{ _('Primary') }}</label>
                            </div>
                            <button type="button" class="btn btn-success btn-sm" onclick="submitBulkAction('bulk_assign')">
                                <i class="bi bi-plus-circle"></i> {{ _('Add') }}
                            </button>
                        </div>
                        
                        <!-- Remove from category -->
                        <div class="input-group input-group-sm" style="max-width: 300px;">
                            <select name="remove_from_category" class="form-select form-select-sm">
                                <option value="">{{ _('All categories') }}</option>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-danger btn-sm" onclick="submitBulkAction('bulk_remove')">
                                <i class="bi bi-trash"></i> {{ _('Remove') }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Products table -->
        {% if products %}
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th>{{ _('Article') }}</th>
                        <th>{{ _('Name') }}</th>
                        <th>{{ _('Brand') }}</th>
                        <th>{{ _('Categories') }}</th>
                        <th class="text-end" style="width: 80px;">{{ _('Price') }}</th>
                        <th class="text-end" style="width: 60px;">{{ _('Qty') }}</th>
                        <th style="width: 60px;">{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>
                            <input type="checkbox" name="articles" value="{{ product.article }}" 
                                   class="form-check-input product-checkbox" onchange="updateSelectedCount()">
                        </td>
                        <td>
                            <a href="{{ url_for('product_details', article=product.article) }}" target="_blank">
                                <code>{{ product.article }}</code>
                            </a>
                        </td>
                        <td class="text-truncate" style="max-width: 200px;" title="{{ product.name_sk or '‚Äî' }}">
                            {{ product.name_sk or '‚Äî' }}
                        </td>
                        <td>
                            {% if product.brand_name %}
                            <a href="{{ url_for('admin_product_categories', token=token, brand=product.brand_id) }}" 
                               class="badge bg-secondary text-decoration-none">
                                {{ product.brand_name }}
                            </a>
                            {% else %}
                            ‚Äî
                            {% endif %}
                        </td>
                        <td>
                            {% if product.categories %}
                            <div class="d-flex flex-wrap gap-1">
                                {% for cat_name in product.categories.split(', ') %}
                                <span class="badge {% if '‚òÖ' in cat_name %}bg-primary{% else %}bg-outline-secondary border{% endif %} small">
                                    {{ cat_name }}
                                </span>
                                {% endfor %}
                            </div>
                            {% if product.category_count > 1 %}
                            <small class="text-muted">({{ product.category_count }} {{ _('categories') }})</small>
                            {% endif %}
                            {% else %}
                            <span class="badge bg-warning text-dark">{{ _('No category') }}</span>
                            {% endif %}
                        </td>
                        <td class="text-end">{{ "%.2f"|format(product.price) if product.price else '‚Äî' }} ‚Ç¨</td>
                        <td class="text-end">
                            <span class="badge bg-{% if product.quantity > 0 %}info{% else %}secondary{% endif %}">
                                {{ product.quantity }}
                            </span>
                        </td>
                        <td>
                            <a href="{{ url_for('admin_product_card', token=token, article=product.article, next=request.full_path) }}" 
                               class="btn btn-sm btn-primary" title="{{ _('Edit Product Card') }}">
                                <i class="bi bi-pencil-square"></i>
                            </a>
                            {% if product.category_count and product.category_count > 1 %}
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    data-bs-toggle="modal" data-bs-target="#primaryModal{{ loop.index }}"
                                    title="{{ _('Set primary category') }}">
                                <i class="bi bi-star"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div class="card-footer">
            <nav>
                <ul class="pagination pagination-sm mb-0 justify-content-center">
                    {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin_product_categories', token=token, article=article_filter, category=category_filter, brand=brand_filter, status=status_filter, page=1) }}">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin_product_categories', token=token, article=article_filter, category=category_filter, brand=brand_filter, status=status_filter, page=page-1) }}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for p in page_range %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('admin_product_categories', token=token, article=article_filter, category=category_filter, brand=brand_filter, status=status_filter, page=p) }}">
                            {{ p }}
                        </a>
                    </li>
                    {% endfor %}
                    
                    {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin_product_categories', token=token, article=article_filter, category=category_filter, brand=brand_filter, status=status_filter, page=page+1) }}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin_product_categories', token=token, article=article_filter, category=category_filter, brand=brand_filter, status=status_filter, page=total_pages) }}">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
        {% else %}
        <div class="card-body">
            <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle me-2"></i>
                {{ _('No products found for the selected filters.') }}
            </div>
        </div>
        {% endif %}
    </div>
</form>

<!-- Modals for setting primary category -->
{% for product in products %}
{% if product.category_count and product.category_count > 1 and product.category_ids %}
<div class="modal fade" id="primaryModal{{ loop.index }}" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title"><i class="bi bi-star"></i> {{ _('Set Primary Category') }}</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <input type="hidden" name="action" value="set_primary">
                    <input type="hidden" name="article" value="{{ product.article }}">
                    <p class="mb-2"><strong>{{ product.article }}</strong></p>
                    <select name="primary_category" class="form-select form-select-sm">
                        {% for cat_id in product.category_ids %}
                        {% for cat in categories %}
                        {% if cat.id == cat_id %}
                        <option value="{{ cat_id }}">{{ cat.name }}</option>
                        {% endif %}
                        {% endfor %}
                        {% endfor %}
                    </select>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-sm btn-primary">
                        <i class="bi bi-star-fill"></i> {{ _('Set Primary') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    
    productCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateSelectedCount();
}

function updateSelectedCount() {
    const checked = document.querySelectorAll('.product-checkbox:checked').length;
    const total = document.querySelectorAll('.product-checkbox').length;
    document.getElementById('selectedCount').textContent = `${checked} {{ _('selected') }}`;
    
    const selectAll = document.getElementById('selectAllCheckbox');
    selectAll.checked = checked === total && total > 0;
    selectAll.indeterminate = checked > 0 && checked < total;
}

function submitBulkAction(action) {
    const form = document.getElementById('bulkForm');
    const checked = document.querySelectorAll('.product-checkbox:checked').length;
    
    if (checked === 0) {
        alert('{{ _("Please select at least one product") }}');
        return;
    }
    
    if (action === 'bulk_assign') {
        const category = document.querySelector('select[name="target_category"]').value;
        if (!category) {
            alert('{{ _("Please select a category") }}');
            return;
        }
    }
    
    const existingAction = form.querySelector('input[name="action"]');
    if (existingAction) existingAction.remove();
    
    const hidden = document.createElement('input');
    hidden.type = 'hidden';
    hidden.name = 'action';
    hidden.value = action;
    form.appendChild(hidden);
    
    form.submit();
}

document.addEventListener('DOMContentLoaded', function() {
    updateSelectedCount();
    highlightSelectedCategories();
});

// JavaScript —Ä—ñ—à–µ–Ω–Ω—è –¥–ª—è –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –≤–∏–±—Ä–∞–Ω–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –≤ dropdown
function highlightSelectedCategories() {
    const selects = document.querySelectorAll('.category-select');
    
    selects.forEach(select => {
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∏–ª—ñ–≤ –æ–ø—Ü—ñ–π
        function updateOptionStyles() {
            const options = select.querySelectorAll('option');
            options.forEach(option => {
                if (option.selected) {
                    option.style.backgroundColor = '#2563eb';
                    option.style.color = 'white';
                    option.style.fontWeight = 'bold';
                } else {
                    option.style.backgroundColor = 'white';
                    option.style.color = '#000';
                    option.style.fontWeight = 'normal';
                }
            });
        }
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        updateOptionStyles();
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∏ –∑–º—ñ–Ω—ñ
        select.addEventListener('change', updateOptionStyles);
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ dropdown (–¥–ª—è –¥–µ—è–∫–∏—Ö –±—Ä–∞—É–∑–µ—Ä—ñ–≤)
        select.addEventListener('focus', updateOptionStyles);
        select.addEventListener('click', updateOptionStyles);
    });
}
</script>
{% endblock %}
