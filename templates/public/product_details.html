{% extends "base/public_base.html" %}

{% block head %}
<!-- SEO Meta Tags -->
<meta name="description" content="{{ product_data.description[:160]|replace('%', '%%')|replace('=', '\=') }}">
<meta name="keywords" content="{{ product_data.name|replace('%', '%%')|replace('=', '\=') }}, {{ article }}, {{ _('auto parts') }}, {{ _('spare parts') }}">
<meta property="og:title" content="{{ product_data.name|replace('%', '%%')|replace('=', '\=') }} - AutogroupEU">
<meta property="og:description" content="{{ product_data.description[:160]|replace('%', '%%')|replace('=', '\=') }}">
<meta property="og:type" content="product">
<meta property="og:url" content="{{ request.host_url }}{{ session.get('language', 'uk') }}/product/{{ article }}">

<!-- Google Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": "{{ product_data.name }}",
  "description": "{{ product_data.description }}",
  "sku": "{{ article }}",
  "image": [
    {% for url in product_data.photo_urls %}
    "{{ url }}"{% if not loop.last %},{% endif %}
    {% endfor %}
  ],
  "brand": {
    "@type": "Brand",
    "name": "{{ brand_name if brand_name else 'AutogroupEU' }}"
  },
  "offers": {
    "@type": "AggregateOffer",
    "priceCurrency": "EUR",
    "lowPrice": "{{ prices[0].price if prices }}",
    "highPrice": "{{ prices[-1].price if prices }}",
    "offerCount": "{{ prices|length }}",
    "availability": "https://schema.org/InStock"
  }
}
</script>

<!-- Google Analytics Enhanced Ecommerce -->
<script>
gtag('event', 'view_item', {
  currency: "EUR",
  items: [{
    item_id: "{{ article }}",
    item_name: "{{ product_data.name }}",
    item_brand: "{{ brand_name|default('AutogroupEU') }}",
    price: "{{ prices[0].price if prices else '' }}"
  }]
});
</script>
{% endblock %}

{% block title %}{{ product_data.name }}{% endblock %}

{% block extra_css %}
<style>
    /* Додайте ці стилі в блок extra_css, якщо вони відсутні */

    /* ==== ПОШУКОВА СЕКЦІЯ ==== */
    .search-card {
        border: none;
        box-shadow: var(--shadow);
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        margin-bottom: 2.5rem;
        transition: all 0.3s ease;
        background-color: white;
    }

    .search-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .search-body {
        padding: 1.75rem;
        background-color: white;
    }

    .input-group {
        position: relative;
    }

    .form-control {
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius) 0 0 var(--border-radius);
        transition: all 0.3s ease;
        font-size: 1rem;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        outline: none;
    }

    .btn-search {
        padding: 0.75rem 1.5rem;
        background-color: var(--primary-color);
        border: none;
        color: white;
        border-radius: 0 var(--border-radius) var(--border-radius) 0;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .btn-search:hover {
        background-color: var(--primary-hover);
        transform: translateY(-2px);
    }

    @media (max-width: 768px) {
        .search-body {
            padding: 1.25rem;
        }
        
        .btn-search {
            width: 100%;
            justify-content: center;
        }
    }
    /* Кольорова гама */
    :root {
        --primary-color: #007bff;
        --primary-hover: #0056b3;
        --secondary-color: #6c757d;
        --light-bg: #f8f9fa;
        --dark-bg: #343a40;
        --border-color: #dee2e6;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
        
        /* Тіні */
        --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
        --shadow: 0 4px 6px rgba(0,0,0,0.1);
        --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
        
        /* Скруглення кутів */
        --border-radius: 0.375rem;
        --border-radius-lg: 0.5rem;
    }

    /* === ЗАГАЛЬНІ СТИЛІ === */
    .product-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 2rem;
        animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* === ЗОБРАЖЕННЯ ПРОДУКТУ === */
    .image-section {
        position: relative;
        height: 450px;
        background-color: white;
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow);
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .image-section:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }
    
    .image-container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
    }
    
    .image-container img {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        transition: transform 0.5s ease, opacity 0.3s ease;
    }
    
    .image-container:hover img {
        transform: scale(1.05);
    }
    
    .image-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 40px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: var(--shadow-sm);
        z-index: 2;
        border: none;
        transition: all 0.3s ease;
        opacity: 0.8;
    }
    
    .image-nav:hover {
        background-color: var(--primary-color);
        color: white;
        opacity: 1;
        transform: translateY(-50%) scale(1.1);
    }
    
    .image-nav.prev {
        left: 15px;
    }
    
    .image-nav.next {
        right: 15px;
    }
    
    .image-dots {
        position: absolute;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        background: rgba(255,255,255,0.8);
        padding: 5px 10px;
        border-radius: 20px;
        z-index: 2;
    }
    
    .image-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: var(--border-color);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .image-dot.active {
        background-color: var(--primary-color);
        transform: scale(1.2);
    }
    
    /* === ІНФОРМАЦІЯ ПРО ПРОДУКТ === */
    .product-info-card {
        border: none;
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
    }
    
    .product-info-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }
    
    .product-info-header {
        background: linear-gradient(135deg, var(--primary-color), #0d6efd);
        color: white;
        padding: 1.25rem;
        border: none;
    }
    
    .product-info-header h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .product-info-body {
        padding: 1.5rem;
        background-color: white;
    }
    
    .product-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .product-meta-item {
        display: flex;
        align-items: center;
    }
    
    .meta-label {
        font-weight: 600;
        color: var(--secondary-color);
        margin-right: 0.5rem;
        min-width: 60px;
    }
    
    .meta-value {
        font-weight: 500;
    }
    
    .article-badge {
        background: var(--light-bg);
        padding: 0.35rem 0.65rem;
        border-radius: 4px;
        font-family: monospace;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--dark-bg);
        display: inline-block;
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }
    
    .article-badge:hover {
        background-color: #e9f2ff;
        border-color: var(--primary-color);
    }
    
    /* === ЦІНИ === */
    .price-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .price-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
        border-color: var(--primary-color);
    }
    
    .price-info {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 1rem;
    }
    
    .price-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    .delivery-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0;
        color: var(--secondary-color);
        font-size: 0.95rem;
        width: 100%;
    }
    
    /* === СЕКЦІЯ ОПИСУ === */
    .description-section {
        border: none;
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        margin-top: 1.5rem;
    }
    
    .description-section:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }
    
    .description-header {
        padding: 1.25rem;
        background: linear-gradient(135deg, var(--secondary-color), #495057);
        color: white;
        border: none;
    }
    
    .description-header h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .description-body {
        padding: 1.5rem;
        background-color: white;
        line-height: 1.7;
    }
    
    /* === ФОРМА ДОДАВАННЯ В КОШИК === */
    .cart-form {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
        margin-top: 1rem;
        width: 100%;
    }
    
    .quantity-input {
        width: 80px !important;
        text-align: center;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 0.5rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .quantity-input:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
    }
    
    .btn-add-to-cart {
        background-color: var(--success-color);
        color: white;
        border: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1.25rem;
        border-radius: var(--border-radius);
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        flex-grow: 1;
    }
    
    .btn-add-to-cart:hover {
        background-color: #218838;
        transform: translateY(-3px);
        box-shadow: var(--shadow);
    }
    
    /* === АДАПТИВНІСТЬ === */
    @media (max-width: 768px) {
        .product-container {
            padding: 1rem;
            margin: 1rem auto;
        }
        
        .image-section {
            height: 300px;
        }
        
        .product-info-header h1 {
            font-size: 1.25rem;
        }
        
        .price-value {
            font-size: 1.5rem;
        }
        
        .image-nav {
            width: 32px;
            height: 32px;
        }
        
        .product-meta {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .product-meta-item {
            width: 100%;
        }
        
        .cart-form {
            flex-direction: column;
        }
        
        .quantity-input {
            width: 100% !important;
        }
        
        .btn-add-to-cart {
            width: 100%;
        }
    }
    
    @media (max-width: 576px) {
        .image-section {
            height: 250px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="page-header fade-in">
        <h2>{{ _("Product Details") }}</h2>
    </div>
        <!-- Пошукова форма -->
    <div class="row mb-4">
        <div class="col-lg-8 mx-auto">
            <div class="search-card fade-in">
                <div class="search-body">
                    <form method="POST" action="{{ url_for('public_search') }}" class="mb-0">
                        <div class="input-group">
                            <input type="text" name="article" class="form-control form-control-lg"
                                placeholder="{{ _('Enter article number...') }}" required>
                            <button type="submit" class="btn-search">
                                <i class="bi bi-search me-2"></i>
                                {{ _('Search') }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="product-container fade-in" itemscope itemtype="https://schema.org/Product">
        <div class="row">
            <!-- Ліва колонка: зображення та опис -->
            <div class="col-md-6">
                <!-- Фото секція -->
                <div class="image-section">
                    <div class="image-container">
                        <img id="productImage" 
                             src="{{ product_data.photo_urls[0] if product_data.photo_urls else url_for('static', filename='placeholder.png') }}" 
                             alt="{{ product_data.name }}"
                             itemprop="image">
                    </div>
                    
                    {% if product_data.photo_urls|length > 1 %}
                    <button type="button" class="image-nav prev">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button type="button" class="image-nav next">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <div class="image-dots">
                        {% for url in product_data.photo_urls %}
                        <div class="image-dot {% if loop.first %}active{% endif %}" 
                             data-index="{{ loop.index0 }}"></div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Опис -->
                <div class="description-section">
                    <div class="description-header">
                        <h2><i class="bi bi-info-circle me-2"></i>{{ _('Description') }}</h2>
                    </div>
                    <div class="description-body">
                        <p itemprop="description">{{ product_data.description }}</p>
                    </div>
                </div>
            </div>

            <!-- Права колонка: інформація та ціни -->
            <div class="col-md-6">
                <div class="product-info-card">
                    <div class="product-info-header">
                        <h1 itemprop="name">{{ product_data.name }}</h1>
                    </div>
                    <div class="product-info-body">
                        <div class="product-meta">
                            <div class="product-meta-item">
                                <span class="meta-label">{{ _('Article') }}:</span>
                                <span class="article-badge" itemprop="sku">{{ article }}</span>
                            </div>
                            
                            <div class="product-meta-item">
                                <span class="meta-label">{{ _('Brand') }}:</span>
                                <span class="meta-value" itemprop="brand">
                                    {% if prices and prices[0]['brand_name'] %}
                                        {{ prices[0]['brand_name'] }}
                                    {% else %}
                                        {{ product_data.brand_name if product_data.brand_name else 'None' }}
                                    {% endif %}
                                </span>
                            </div>
                        </div>

                        <!-- Ціни -->
                        <h4 class="mb-3"><i class="bi bi-tag-fill me-2 text-primary"></i>{{ _('Available Prices') }}</h4>
                        {% for price in prices %}
                        <div class="price-card">
                            <div class="price-info">
                                <span class="price-value" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
                                    <span itemprop="price">{{ "%.2f"|format(price.price|float) }}</span> 
                                    <span itemprop="priceCurrency">EUR</span>
                                </span>
                                
                                <span class="delivery-info">
                                    {% if price.in_stock %}
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                    {{ _('In Stock') }}
                                    {% else %}
                                    <i class="bi bi-clock text-warning"></i>
                                    {{ price.delivery_time }}
                                    {% endif %}
                                </span>
                                
                                <form method="POST" action="{{ url_for('public_add_to_cart') }}" class="cart-form">
                                    <input type="hidden" name="article" value="{{ article }}">
                                    <input type="hidden" name="selected_price" value="{{ price.table_name }}:{{ price.price }}|{{ price.brand_id }}">
                                    <input type="number" 
                                           name="quantity_{{ price.table_name }}" 
                                           value="1" 
                                           min="1" 
                                           class="quantity-input">
                                    <button type="submit" class="btn-add-to-cart">
                                        <i class="bi bi-cart-plus me-2"></i>
                                        {{ _('Add to Cart') }}
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <div class="mt-4">
                            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-left me-2"></i>
                                {{ _('Continue Shopping') }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Зберігаємо всі шляхи до фотографій
const images = {{ product_data.photo_urls | tojson | safe }};
let currentImageIndex = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Знаходимо всі елементи для навігації по фото
    const dots = document.querySelectorAll('.image-dot');
    const imgElement = document.getElementById('productImage');
    const prevButton = document.querySelector('.image-nav.prev');
    const nextButton = document.querySelector('.image-nav.next');
    
    if (!imgElement || images.length <= 1) return;
    
    // Функція оновлення індикаторів (точок)
    function updateDots(index) {
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === index);
        });
    }
    
    // Функція зміни зображення
    function changeImage(index) {
        if (!imgElement) return;
        imgElement.style.opacity = '0';
        
        setTimeout(() => {
            imgElement.src = images[index];
            imgElement.style.opacity = '1';
            currentImageIndex = index;
            updateDots(index);
        }, 300);
    }
    
    // Функція для переходу до попереднього зображення
    function prevImage() {
        if (images.length <= 1) return;
        let newIndex = currentImageIndex <= 0 ? images.length - 1 : currentImageIndex - 1;
        changeImage(newIndex);
    }
    
    // Функція для переходу до наступного зображення
    function nextImage() {
        if (images.length <= 1) return;
        let newIndex = currentImageIndex >= images.length - 1 ? 0 : currentImageIndex + 1;
        changeImage(newIndex);
    }
    
    // Додавання обробників подій для кнопок
    if (prevButton) {
        prevButton.addEventListener('click', prevImage);
    }
    
    if (nextButton) {
        nextButton.addEventListener('click', nextImage);
    }
    
    // Додавання обробників подій для точок
    dots.forEach((dot, index) => {
        dot.addEventListener('click', function() {
            changeImage(index);
        });
    });
    
    // Трекінг додавання до кошика
    const forms = document.querySelectorAll('form.cart-form');
    forms.forEach(function(form) {
        form.addEventListener('submit', function() {
            const selectedPriceField = this.querySelector('input[name="selected_price"]');
            const quantityField = this.querySelector('input[type="number"]');
            
            if (selectedPriceField && quantityField) {
                const selectedPriceValue = selectedPriceField.value;
                const priceValue = selectedPriceValue.split(':')[1].split('|')[0];
                
                if (typeof gtag === 'function') {
                    gtag('event', 'add_to_cart', {
                        currency: "EUR",
                        items: [{
                            item_id: "{{ article }}",
                            item_name: "{{ product_data.name }}",
                            item_brand: "{{ product_data.brand_name|default('AutogroupEU') }}",
                            price: priceValue,
                            quantity: parseInt(quantityField.value)
                        }]
                    });
                }
            }
        });
    });
    
    // Додаємо клавіатурну навігацію для зображень
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft') {
            prevImage();
        } else if (e.key === 'ArrowRight') {
            nextImage();
        }
    });
});
</script>
{% endblock %}